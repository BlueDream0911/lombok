<project name="lombok" default="dist">
	<property name="build.compiler" value="javac1.6" />
	<path id="lombok.deps.path">
		<fileset dir="deps/lombok">
			<include name="**/*.jar" />
		</fileset>
	</path>
	<path id="lombok.libs.path">
		<fileset dir="lib/lombok">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<path id="eclipse.agent.deps.path">
		<fileset dir="deps/eclipse.agent">
			<include name="**/*.jar" />
		</fileset>
	</path>
	<path id="eclipse.agent.libs.path">
		<fileset dir="lib/eclipse.agent">
			<include name="**/*.jar" />
		</fileset>
	</path>
	
	<target name="clean">
		<delete dir="build" quiet="true" />
		<delete dir="dist" quiet="true" />
	</target>
	
	<target name="compile">
		<mkdir dir="build/lombok" />
		<!-- This version trickery is so that an eclipse running in a JVM 1.5 will run properly (It'll never touch the javac files and hence never trigger a Bad Class Version Number error
		     but for javac we definitely cannot support javac 1.5, partly because they completely rewrote large swaths of javac, and partly because our injection mechanism (annotations)
		     doesn't work very well on javac 1.5, hence, when using javac, we do demand you're on 1.6. -->
		<javac srcdir="src" debug="on" destdir="build/lombok" target="1.5" excludes="lombok/javac/**">
			<classpath refid="lombok.deps.path" />
			<classpath refid="lombok.libs.path" />
		</javac>
		<javac srcdir="src" debug="on" destdir="build/lombok" target="1.6" includes="lombok/javac/**">
			<classpath refid="lombok.deps.path" />
			<classpath refid="lombok.libs.path" />
		</javac>
		<copy todir="build/lombok">
			<fileset dir="src">
				<exclude name="**/*.java" />
				<exclude name="**/*.class" />
				<exclude name="**/*.svg" />
			</fileset>
		</copy>

		<mkdir dir="build/lombok/META-INF" />
		<mkdir dir="build/lombok/META-INF/services" />
		<echo file="build/lombok/META-INF/services/javax.annotation.processing.Processor">lombok.javac.apt.Processor</echo>
		
		<mkdir dir="build/eclipse.agent" />
		<javac srcdir="src_eclipseagent" debug="on" destdir="build/eclipse.agent" target="1.5">
			<classpath refid="eclipse.agent.deps.path" />
			<classpath refid="eclipse.agent.libs.path" />
		</javac>
	</target>
	
	<target name="unpackLibs">
		<unjar dest="build/lombok">
			<path refid="lombok.libs.path" />
		</unjar>
		<unjar dest="build/eclipse.agent">
			<path refid="eclipse.agent.libs.path" />
		</unjar>
	</target>
	
	<target name="getVersion" depends="compile">
		<java
			classname="lombok.core.Version"
			classpath="build/lombok"
			failonerror="true"
			output="build/version.txt" />
		<loadresource property="lombok.version">
			<file file="build/version.txt" />
			<filterchain>
				<striplinebreaks />
			</filterchain>
		</loadresource>
		<delete file="build/version.txt" quiet="true" />
		<echo level="info">Lombok version: ${lombok.version}</echo>
	</target>
	
	<target name="dist" depends="clean, compile, getVersion, unpackLibs">
		<mkdir dir="dist" />
		<jar basedir="build/eclipse.agent" destfile="dist/lombok.eclipse.agent-${lombok.version}.jar">
			<manifest>
				<attribute name="Premain-Class" value="lombok.eclipse.agent.EclipsePatcher" />
				<attribute name="Can-Redefine-Classes" value="true" />
			</manifest>
		</jar>
		<copy file="dist/lombok.eclipse.agent-${lombok.version}.jar" tofile="dist/lombok.eclipse.agent.jar" />
		<jar destfile="dist/lombok-${lombok.version}.jar">
			<fileset dir="build/lombok" />
			<fileset dir="dist" includes="lombok.eclipse.agent.jar" />
				
			<manifest>
				<attribute name="Main-Class" value="lombok.installer.InstallerWindow" />
			</manifest>
		</jar>
		<copy file="dist/lombok-${lombok.version}.jar" tofile="dist/lombok.jar" />
	</target>
</project>
